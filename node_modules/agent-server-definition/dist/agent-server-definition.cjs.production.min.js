"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t=e(require("fs")),r=e(require("path")),n=e(require("express")),o=e(require("cors")),a=e(require("esbuild")),i=e(require("axios")),s=require("url");function c(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function u(e,t,r,n,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,o)}function l(e){return function(){var t=this,r=arguments;return new Promise((function(n,o){var a=e.apply(t,r);function i(e){u(a,n,o,i,s,"next",e)}function s(e){u(a,n,o,i,s,"throw",e)}i(void 0)}))}}function p(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(r)return(r=r.call(e)).next.bind(r);if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return c(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?c(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function f(){f=function(){return t};var e,t={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(e,t,r){e[t]=r.value},a="function"==typeof Symbol?Symbol:{},i=a.iterator||"@@iterator",s=a.asyncIterator||"@@asyncIterator",c=a.toStringTag||"@@toStringTag";function u(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,r){return e[t]=r}}function l(e,t,r,n){var a=Object.create((t&&t.prototype instanceof g?t:g).prototype),i=new N(n||[]);return o(a,"_invoke",{value:j(e,r,i)}),a}function p(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}t.wrap=l;var h="suspendedStart",d="executing",v="completed",m={};function g(){}function y(){}function x(){}var w={};u(w,i,(function(){return this}));var b=Object.getPrototypeOf,_=b&&b(b(P([])));_&&_!==r&&n.call(_,i)&&(w=_);var E=x.prototype=g.prototype=Object.create(w);function k(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function S(e,t){function r(o,a,i,s){var c=p(e[o],e,a);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==typeof l&&n.call(l,"__await")?t.resolve(l.__await).then((function(e){r("next",e,i,s)}),(function(e){r("throw",e,i,s)})):t.resolve(l).then((function(e){u.value=e,i(u)}),(function(e){return r("throw",e,i,s)}))}s(c.arg)}var a;o(this,"_invoke",{value:function(e,n){function o(){return new t((function(t,o){r(e,n,t,o)}))}return a=a?a.then(o,o):o()}})}function j(t,r,n){var o=h;return function(a,i){if(o===d)throw Error("Generator is already running");if(o===v){if("throw"===a)throw i;return{value:e,done:!0}}for(n.method=a,n.arg=i;;){var s=n.delegate;if(s){var c=L(s,n);if(c){if(c===m)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===h)throw o=v,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=d;var u=p(t,r,n);if("normal"===u.type){if(o=n.done?v:"suspendedYield",u.arg===m)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=v,n.method="throw",n.arg=u.arg)}}}function L(t,r){var n=r.method,o=t.iterator[n];if(o===e)return r.delegate=null,"throw"===n&&t.iterator.return&&(r.method="return",r.arg=e,L(t,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),m;var a=p(o,t.iterator,r.arg);if("throw"===a.type)return r.method="throw",r.arg=a.arg,r.delegate=null,m;var i=a.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=e),r.delegate=null,m):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,m)}function O(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function T(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function N(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(O,this),this.reset(!0)}function P(t){if(t||""===t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,a=function r(){for(;++o<t.length;)if(n.call(t,o))return r.value=t[o],r.done=!1,r;return r.value=e,r.done=!0,r};return a.next=a}}throw new TypeError(typeof t+" is not iterable")}return y.prototype=x,o(E,"constructor",{value:x,configurable:!0}),o(x,"constructor",{value:y,configurable:!0}),y.displayName=u(x,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,x):(e.__proto__=x,u(e,c,"GeneratorFunction")),e.prototype=Object.create(E),e},t.awrap=function(e){return{__await:e}},k(S.prototype),u(S.prototype,s,(function(){return this})),t.AsyncIterator=S,t.async=function(e,r,n,o,a){void 0===a&&(a=Promise);var i=new S(l(e,r,n,o),a);return t.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},k(E),u(E,c,"Generator"),u(E,i,(function(){return this})),u(E,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),r=[];for(var n in t)r.push(n);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},t.values=P,N.prototype={constructor:N,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(T),!t)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var r=this;function o(n,o){return s.type="throw",s.arg=t,r.next=n,o&&(r.method="next",r.arg=e),!!o}for(var a=this.tryEntries.length-1;a>=0;--a){var i=this.tryEntries[a],s=i.completion;if("root"===i.tryLoc)return o("end");if(i.tryLoc<=this.prev){var c=n.call(i,"catchLoc"),u=n.call(i,"finallyLoc");if(c&&u){if(this.prev<i.catchLoc)return o(i.catchLoc,!0);if(this.prev<i.finallyLoc)return o(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return o(i.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return o(i.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var i=a?a.completion:{};return i.type=e,i.arg=t,a?(this.method="next",this.next=a.finallyLoc,m):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),m},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),T(r),m}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var o=n.arg;T(r)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,r,n){return this.delegate={iterator:P(t),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=e),m}},t}var h=function(e){var t=e.toLowerCase().trim(),r={"image/png":"png","image/jpeg":"jpg","image/jpg":"jpg","image/gif":"gif","image/webp":"webp","image/svg+xml":"svg","application/pdf":"pdf","audio/mpeg":"mp3","audio/mp3":"mp3","video/mp4":"mp4","video/mpeg":"mpg","application/json":"json","text/plain":"txt","text/html":"html","text/css":"css","text/javascript":"js","application/javascript":"js","application/xml":"xml","text/xml":"xml","application/zip":"zip","application/x-zip-compressed":"zip","application/msword":"doc","application/vnd.openxmlformats-officedocument.wordprocessingml.document":"docx","application/vnd.ms-excel":"xls","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":"xlsx","application/vnd.ms-powerpoint":"ppt","application/vnd.openxmlformats-officedocument.presentationml.presentation":"pptx"};return r[t]?r[t]:null},d=function(e){if(!e||"string"!=typeof e)return null;var t=e.match(/^data:([^;,]+)(;base64)?,(.*)/);return!t||t.length<4?null:{mimeType:t[1],base64:t[3],buffer:Buffer.from(t[3],"base64")}},v=function(){var e=l(f().mark((function e(n,o,a){var i,s,c,u,l,p;return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===a&&(a="tmp"),e.next=3,t.promises.mkdir(a,{recursive:!0});case 3:if(i=d(n)){e.next=6;break}throw new Error("Invalid base64 data");case 6:return c=i.buffer,u=(s=i.mimeType)?h(s):"",l=o||"file-"+Date.now()+"-"+Math.random().toString(36).substring(2,10),""===r.extname(l)&&(l=l+"."+u),p=r.join(a,l),e.next=13,t.promises.writeFile(p,c);case 13:return e.abrupt("return",p);case 14:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}(),m=function(){var e=l(f().mark((function e(t,r){var n,o,a,i;return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:void 0===r&&(r="tmp"),n=[],o=p(t);case 3:if((a=o()).done){e.next=11;break}return i=a.value,e.next=7,v(i.base64,i.fileName||"file-"+Date.now()+"-"+Math.random().toString(36).substring(2,10),r);case 7:n.push(e.sent);case 9:e.next=3;break;case 11:return e.abrupt("return",n);case 12:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),g=function(){var e=l(f().mark((function e(r){return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.promises.access(r);case 3:return e.next=5,t.promises.unlink(r);case 5:return e.abrupt("return",!0);case 8:if(e.prev=8,e.t0=e.catch(0),"ENOENT"!==e.t0.code){e.next=12;break}return e.abrupt("return",!1);case 12:throw e.t0;case 13:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t){return e.apply(this,arguments)}}(),y=function(){var e=l(f().mark((function e(t){var r;return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r={deleted:[],notFound:[],failed:[]},e.next=3,Promise.all(t.map(function(){var e=l(f().mark((function e(t){return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,g(t);case 3:e.sent?r.deleted.push(t):r.notFound.push(t),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),r.failed.push({path:t,error:e.t0.message||String(e.t0)});case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t){return e.apply(this,arguments)}}()));case 3:return e.abrupt("return",r);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),x=function(){var e=l(f().mark((function e(n,o){var a,i,s,c,u,l;return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===n&&(n="tmp"),void 0===o&&(o=864e5),e.prev=2,e.next=5,t.promises.access(n);case 5:return e.next=7,t.promises.readdir(n);case 7:a=e.sent,i=Date.now(),s=[],c=p(a);case 11:if((u=c()).done){e.next=27;break}return l=r.join(n,u.value),e.prev=14,e.next=17,t.promises.stat(l);case 17:i-e.sent.mtimeMs>o&&s.push(l),e.next=25;break;case 22:e.prev=22,e.t0=e.catch(14),console.error("Error checking file "+l+":",e.t0);case 25:e.next=11;break;case 27:return e.next=29,y(s);case 29:return e.abrupt("return",e.sent);case 32:if(e.prev=32,e.t1=e.catch(2),"ENOENT"!==e.t1.code){e.next=36;break}return e.abrupt("return",{deleted:[],notFound:[],failed:[]});case 36:throw e.t1;case 37:case"end":return e.stop()}}),e,null,[[2,32],[14,22]])})));return function(t,r){return e.apply(this,arguments)}}(),w=function(e,t){if(void 0===t&&(t=!1),!e||"string"!=typeof e)return!1;if(!/^[A-Za-z0-9+/]*={0,2}$/.test(e))return!1;if(e.length%4!=0)return!1;var r=e.match(/=*$/);if(r&&r[0].length>2)return!1;if(t)try{return Buffer.from(e,"base64").toString(),!0}catch(e){return!1}return!0},b=function(e){return!(!e||"string"!=typeof e)&&/^data:([^;,]+)(;base64)?,/.test(e)},_="https://agent-service.eternalai.org/api/v1",E={__proto__:null,PORT_LOCAL_MODEL:65534,PORT_AGENT_ROUTER:33030,PORT_AGENT_PROMPT_BASE:80,PORT_AGENT_STANDALONE:8080,API_PROVIDER_URL:_},k=function(){var e=l(f().mark((function e(t){var r,n;return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.userAddress,e.prev=1,e.next=4,fetch(_+"/agent/wallet",{method:"POST",body:JSON.stringify({user_address:r}),headers:{"Content-Type":"application/json"}});case 4:if((n=e.sent).ok){e.next=7;break}throw new Error("Error fetching wallet: "+n.statusText);case 7:return e.next=9,n.json();case 9:return e.abrupt("return",e.sent.data);case 13:throw e.prev=13,e.t0=e.catch(1),new Error("Error fetching wallet: "+e.t0);case 16:case"end":return e.stop()}}),e,null,[[1,13]])})));return function(t){return e.apply(this,arguments)}}(),S=function(){var e=l(f().mark((function e(t){var r;return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch(_+"/agent/wallet/"+t,{method:"GET",headers:{"Content-Type":"application/json"}});case 3:if((r=e.sent).ok){e.next=6;break}throw new Error("Error fetching wallet: "+r.statusText);case 6:return e.next=8,r.json();case 8:return e.abrupt("return",e.sent.data);case 12:throw e.prev=12,e.t0=e.catch(0),new Error("Error fetching wallet: "+e.t0);case 15:case"end":return e.stop()}}),e,null,[[0,12]])})));return function(t){return e.apply(this,arguments)}}(),j={__proto__:null,getBaseFromBase64:function(e,t){var r=[];return t.forEach((function(t){Array.isArray(t.content)&&t.content.forEach((function(t){if(t.type===e){var n=t[e].url.split(","),o=n[1];r.push({type:n[0].split(":")[1].split(";")[0],base64:o,fileName:t[e].detail})}}))})),r},parseDataUrl:d,createFileFromBase64:v,createFilesFromBase64Results:m,deleteFile:g,deleteFiles:y,cleanupTempFiles:x,isBase64:w,isDataUrl:b,parseBase64Input:function(e){if(!e||"string"!=typeof e)return null;if(b(e)){var t=d(e);return t?{type:"dataUrl",content:t.base64,mimeType:t.mimeType}:null}return w(e)?{type:"base64",content:e}:null},generateWalletForDeposit:function(){var e=l(f().mark((function e(t){var r;return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,k({userAddress:t});case 2:return r=e.sent,e.next=5,S(r.api_key);case 5:return e.abrupt("return",e.sent);case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},L=function(e){try{return e.startsWith("http://")||e.startsWith("https://")?new s.URL(e).hostname:new s.URL("http://"+e).hostname}catch(r){try{var t=e;return t.startsWith("http://")&&(t=t.replace("http://","")),t.startsWith("https://")&&(t=t.replace("https://","")),t.endsWith("/")&&(t=t.slice(0,-1)),t.split("/")[0]}catch(e){}}return e};exports.constants=E,exports.setupRequestMiddleware=function(e){var t=e.from,r=e.to,n=e.privateKey,o=e.chainId;!function(){i.interceptors.request.use((function(e){return e}),(function(e){return Promise.reject(e)}));var e=global.fetch;global.fetch=function(){var t=l(f().mark((function t(r,n){return f().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return void 0===n&&(n={}),t.prev=2,t.next=5,e(r,n);case 5:return t.abrupt("return",t.sent);case 9:throw t.prev=9,t.t0=t.catch(2),t.t0;case 12:case"end":return t.stop()}}),t,null,[[2,9]])})));return function(e,r){return t.apply(this,arguments)}}()}();var a=t instanceof Array?t.map((function(e){return e.trim()})).filter((function(e){return!!e})):(""+t).trim();"string"==typeof a&&"*"!==a?a=L(a):"object"==typeof a&&(a=a.map((function(e){return L(e)})));var c=(""+r).trim();if(a&&c){var u=i.create,p=function(){return c},h=function(e,t){return e.toLowerCase()===t.toLowerCase()},d=function(e){try{if(a instanceof Array){if(a.find((function(t){return h(t,e)})))return!0}else if("*"===a){var t=L(c);if(!h(e,t))return!0}else if(h(e,a))return!0;return!1}catch(e){return!1}};i.create=function(e){void 0===e&&(e={});var t=u(e);return t.interceptors.request.use((function(e){try{var t=e;if(e.url){var r=e.url.startsWith("http")?new s.URL(e.url):new s.URL(e.url,e.baseURL||void 0),a=r.toString();d(r.hostname)&&(console.log("_____overwrite request url_____",r.href,c),r.hostname=c,e.url=p(),e.method="POST",e.data=JSON.parse(JSON.stringify({privateKey:n,chainId:o,messages:[{role:"user",content:JSON.stringify({url:a,method:t.method||"GET",body:t.data,headers:t.headers})}]})))}}catch(e){console.error("Error processing axios request:",e)}return e}),(function(e){return Promise.reject(e)})),t},i.interceptors.request.use((function(e){try{var t=e;if(e.url){var r=e.url.startsWith("http")?new s.URL(e.url):new s.URL(e.url,e.baseURL||void 0),a=r.toString();d(r.hostname)&&(console.log("_____overwrite request url_____",r.href,c),r.hostname=c,e.url=p(),e.method="POST",e.data=JSON.parse(JSON.stringify({privateKey:n,chainId:o,messages:[{role:"user",content:JSON.stringify({url:a,method:t.method||"GET",body:t.data,headers:t.headers})}]})))}}catch(e){console.error("Error processing axios request:",e)}return e}),(function(e){return Promise.reject(e)}));var v=global.fetch;"function"==typeof v&&(global.fetch=function(){var e=l(f().mark((function e(t,r){var a,i,u,l;return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,a="string"==typeof t?t:t instanceof s.URL?t.toString():t.url,i=new s.URL(a),!d(i.hostname)){e.next=11;break}return console.log("_____overwrite request url_____",i.href,c),u={},i.hostname=c,u={privateKey:n,chainId:o,messages:[{role:"user",content:JSON.stringify({url:a,method:(null==r?void 0:r.method)||"GET",body:null==r?void 0:r.body,headers:null==r?void 0:r.headers,search:i.searchParams})}]},"string"==typeof t?(t=i.toString(),u.url=t):t instanceof s.URL?u.url=t=i:(t=new Request(i,t),u.url=t.url),l=v(p(),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)}),e.abrupt("return",l);case 11:e.next=16;break;case 13:e.prev=13,e.t0=e.catch(0),console.error("Error processing fetch request:",e.t0);case 16:return e.abrupt("return",v(t,r));case 17:case"end":return e.stop()}}),e,null,[[0,13]])})));return function(t,r){return e.apply(this,arguments)}}()),a instanceof Array?console.log("Request interceptor active: redirecting "+a.join(",")+" → "+c):"*"===a?console.log("Request interceptor active: redirecting all domain → "+c):console.log("Request interceptor active: redirecting "+a+" → "+c)}},exports.startServer=function(e,t,i,s){var c;void 0===i&&(i={enableStaticServing:!1,isStreamSupported:!1,extendedRoutes:[]});var u=(null==(c=i)?void 0:c.logger)||!1,p=n();if(!e)throw new Error("Port is required");if(!t)throw new Error("Prompt function is required");if(p.use(o({origin:"*",methods:"*",allowedHeaders:"*",credentials:!0})),p.use(n.json({limit:"50mb"})),p.use(n.urlencoded({extended:!0})),p.options("*",o()),i.enableStaticServing){var h=i.staticDir||r.join(process.cwd(),"public"),d=i.staticUrlPath||"/";console.log("Serving static files from: "+h+" at path: "+d),p.get("/*.tsx",function(){var e=l(f().mark((function e(t,n){var o,s,c;return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=i.staticDir||r.join(process.cwd(),"public"),s=r.join(o,t.path),e.prev=2,e.next=5,a.build({entryPoints:[s],bundle:!0,write:!1,platform:"browser",loader:{".tsx":"tsx"},format:"esm",target:["esnext"],jsx:"automatic"});case 5:c=e.sent,n.type("application/javascript").send(c.outputFiles[0].text),e.next=13;break;case 9:e.prev=9,e.t0=e.catch(2),console.error("TSX build error:",e.t0),n.status(500).send("Error building TSX: "+e.t0.message);case 13:case"end":return e.stop()}}),e,null,[[2,9]])})));return function(t,r){return e.apply(this,arguments)}}()),p.get("/*.ts",function(){var e=l(f().mark((function e(t,n){var o,s,c;return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=i.staticDir||r.join(process.cwd(),"public"),s=r.join(o,t.path),e.prev=2,e.next=5,a.build({entryPoints:[s],bundle:!0,write:!1,platform:"browser",loader:{".ts":"ts"},format:"esm",target:["esnext"]});case 5:c=e.sent,n.type("application/javascript").send(c.outputFiles[0].text),e.next=13;break;case 9:e.prev=9,e.t0=e.catch(2),console.error("TS build error:",e.t0),n.status(500).send("Error building TS: "+e.t0.message);case 13:case"end":return e.stop()}}),e,null,[[2,9]])})));return function(t,r){return e.apply(this,arguments)}}()),p.use(d,n.static(h,{extensions:["html"],setHeaders:function(e,t){t.endsWith(".tsx")&&(e.statusCode=404)}})),"/"===d&&r.join(h,"index.html")&&p.get("*",(function(e,t,n){e.path.startsWith("/api")||e.path.startsWith("/prompt")?n():t.sendFile(r.join(h,"index.html"))}))}p.post("/prompt",function(){var e=l(f().mark((function e(r,n){var o,a,s,c,l,p,h;return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=r.body,u&&console.log("prompt: payload",o),e.prev=2,!o.ping){e.next=7;break}n.send("online"),e.next=57;break;case 7:if(null==(a=i)||!a.isStreamSupported||!o.stream){e.next=52;break}return n.setHeader("Content-Type","text/event-stream"),n.setHeader("Cache-Control","no-cache"),n.setHeader("Connection","keep-alive"),e.prev=11,e.next=14,t(o);case 14:if(!((s=e.sent)instanceof ReadableStream)){e.next=40;break}c=s.getReader(),e.prev=17;case 18:return e.next=21,c.read();case 21:if(p=(l=e.sent).value,!l.done){e.next=26;break}return e.abrupt("break",29);case 26:n.write(p),e.next=18;break;case 29:e.next=35;break;case 31:e.prev=31,e.t0=e.catch(17),console.error("Stream reading error:",e.t0),n.write("data: "+JSON.stringify({error:e.t0.message})+"\n\n");case 35:return e.prev=35,n.end(),e.finish(35);case 38:e.next=43;break;case 40:n.write("data: "+JSON.stringify(s)+"\n\n"),n.write("data: [DONE]\n\n"),n.end();case 43:e.next=50;break;case 45:e.prev=45,e.t1=e.catch(11),console.error("Stream processing error:",e.t1),n.write("data: "+JSON.stringify({error:e.t1.message})+"\n\n"),n.end();case 50:e.next=57;break;case 52:return e.next=54,t(o);case 54:h=e.sent,u&&console.log("prompt: result",h),n.json(h);case 57:e.next=63;break;case 59:e.prev=59,e.t2=e.catch(2),console.log("prompt: error",e.t2),n.status(500).json({error:e.t2.message});case 63:case"end":return e.stop()}}),e,null,[[2,59],[11,45],[17,31,35,38]])})));return function(t,r){return e.apply(this,arguments)}}()),p.get("/health",(function(e,t){t.status(200).json({status:"ok"})}));try{var v;null==(v=i)||null==(v=v.extendedRoutes)||v.forEach((function(e){try{p[e.method.toLowerCase()](e.path,e.handler)}catch(e){console.error("Error adding extended routes:",e)}}))}catch(e){console.error("Error adding extended routes:",e)}return p.listen(e,(function(t){t?console.error("Error starting server:",t):(console.log("Server is running on http://localhost:"+e),s&&s(t))})),p},exports.utils=j;
//# sourceMappingURL=agent-server-definition.cjs.production.min.js.map
